<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Shopify API - Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .info-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        
        .info-banner h3 {
            margin-bottom: 10px;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        label {
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }
        
        input {
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .button-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        button {
            padding: 18px 30px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            color: white;
        }
        
        .btn-cached {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .btn-refresh {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .btn-sse {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .status-area {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        .status-label {
            font-weight: 600;
            color: #333;
        }
        
        .status-value {
            color: #667eea;
            font-weight: 500;
        }
        
        .response-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            min-height: 300px;
        }
        
        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
        }
        
        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .badge-cached {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .badge-fresh {
            background: #e8f5e9;
            color: #388e3c;
        }
        
        .badge-loading {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .response-body {
            background: #fff;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #dee2e6;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .success-message {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #4caf50;
        }
        
        .info-message {
            background: #e3f2fd;
            color: #1565c0;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #2196f3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Enhanced Shopify API Demo</h1>
        <p class="subtitle">Instant cached response + Background refresh</p>
        
        <div class="info-banner">
            <h3>üí° How This Works:</h3>
            <ul style="margin-top: 10px; line-height: 1.8;">
                <li>‚úÖ <strong>Instant Response:</strong> Get cached data immediately (no waiting!)</li>
                <li>‚úÖ <strong>Background Refresh:</strong> Fresh data scraped while you view old data</li>
                <li>‚úÖ <strong>Row Ranges:</strong> Specify start_row and end_row to get chunks</li>
                <li>‚úÖ <strong>Real-time Updates:</strong> See progress as data refreshes (SSE)</li>
            </ul>
        </div>
        
        <div class="controls">
            <div class="input-group">
                <label for="apiUrl">API URL:</label>
                <input type="text" id="apiUrl" value="http://localhost:5000" placeholder="http://localhost:5000">
            </div>
            
            <div class="input-group">
                <label for="apiKey">API Key:</label>
                <input type="text" id="apiKey" value="shopify_secure_key_2025" placeholder="API Key">
            </div>
            
            <div class="input-group">
                <label for="startRow">Start Row (optional):</label>
                <input type="number" id="startRow" placeholder="e.g., 1" min="1">
            </div>
            
            <div class="input-group">
                <label for="endRow">End Row (optional):</label>
                <input type="number" id="endRow" placeholder="e.g., 100" min="1">
            </div>
        </div>
        
        <div class="button-group">
            <button class="btn-cached" onclick="getData('cached')">
                ‚ö° Get Cached Data<br><small>(Instant - no refresh)</small>
            </button>
            <button class="btn-refresh" onclick="getData('refresh')">
                üîÑ Cached + Background Refresh<br><small>(Best for UX)</small>
            </button>
            <button class="btn-sse" onclick="getData('sse')">
                üì° Real-time Updates (SSE)<br><small>(Streams progress)</small>
            </button>
        </div>
        
        <div class="status-area" id="statusArea" style="display: none;">
            <div class="status-item">
                <span class="status-label">Request Type:</span>
                <span class="status-value" id="requestType">-</span>
            </div>
            <div class="status-item">
                <span class="status-label">Total Records:</span>
                <span class="status-value" id="totalRecords">-</span>
            </div>
            <div class="status-item">
                <span class="status-label">Returned Records:</span>
                <span class="status-value" id="returnedRecords">-</span>
            </div>
            <div class="status-item">
                <span class="status-label">Row Range:</span>
                <span class="status-value" id="rowRange">-</span>
            </div>
            <div class="status-item">
                <span class="status-label">Response Time:</span>
                <span class="status-value" id="responseTime">-</span>
            </div>
        </div>
        
        <div class="response-container">
            <div class="response-header">
                <div class="response-title" style="font-weight: 600; font-size: 1.2em;">Response:</div>
                <div id="responseBadge"></div>
            </div>
            <div class="response-body" id="response">
                <div style="text-align: center; color: #999; padding: 40px;">
                    Click a button above to test the API
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentTaskId = null;
        let taskCheckInterval = null;
        
        async function getData(mode) {
            const apiUrl = document.getElementById('apiUrl').value;
            const apiKey = document.getElementById('apiKey').value;
            const startRow = document.getElementById('startRow').value;
            const endRow = document.getElementById('endRow').value;
            const responseDiv = document.getElementById('response');
            const badgeDiv = document.getElementById('responseBadge');
            const statusArea = document.getElementById('statusArea');
            
            // Clear previous task interval
            if (taskCheckInterval) {
                clearInterval(taskCheckInterval);
                taskCheckInterval = null;
            }
            
            // Build URL params
            let params = new URLSearchParams();
            if (startRow) params.append('start_row', startRow);
            if (endRow) params.append('end_row', endRow);
            
            try {
                if (mode === 'cached') {
                    await fetchCached(apiUrl, apiKey, params, responseDiv, badgeDiv, statusArea);
                } else if (mode === 'refresh') {
                    await fetchWithRefresh(apiUrl, apiKey, params, responseDiv, badgeDiv, statusArea);
                } else if (mode === 'sse') {
                    await fetchWithSSE(apiUrl, apiKey, params, responseDiv, badgeDiv, statusArea);
                }
            } catch (error) {
                responseDiv.innerHTML = `<div style="color: #f44336; padding: 20px;">${error.message}</div>`;
                badgeDiv.innerHTML = '<span class="badge badge-cached">Error</span>';
            }
        }
        
        async function fetchCached(apiUrl, apiKey, params, responseDiv, badgeDiv, statusArea) {
            showLoading(responseDiv, badgeDiv, 'Fetching cached data...');
            
            const startTime = performance.now();
            const response = await fetch(`${apiUrl}/api/data?${params}`, {
                headers: { 'X-API-Key': apiKey }
            });
            const elapsed = ((performance.now() - startTime) / 1000).toFixed(3);
            
            const data = await response.json();
            
            updateStatus(statusArea, 'Cached Only', data, elapsed);
            badgeDiv.innerHTML = '<span class="badge badge-cached">üì¶ Cached Data</span>';
            responseDiv.innerHTML = JSON.stringify(data, null, 2);
        }
        
        async function fetchWithRefresh(apiUrl, apiKey, params, responseDiv, badgeDiv, statusArea) {
            showLoading(responseDiv, badgeDiv, 'Fetching cached data + triggering refresh...');
            
            // Add refresh=true parameter
            params.append('refresh', 'true');
            
            const startTime = performance.now();
            const response = await fetch(`${apiUrl}/api/data?${params}`, {
                headers: { 'X-API-Key': apiKey }
            });
            const elapsed = ((performance.now() - startTime) / 1000).toFixed(3);
            
            const data = await response.json();
            
            updateStatus(statusArea, 'Cached + Refresh', data, elapsed);
            
            // Show cached data immediately
            badgeDiv.innerHTML = '<span class="badge badge-cached">üì¶ Cached Data</span>';
            responseDiv.innerHTML = JSON.stringify(data, null, 2);
            
            // If refresh was triggered, start polling for updates
            if (data.refresh_triggered && data.task_id) {
                showRefreshMessage(responseDiv, data);
                startPollingTask(apiUrl, apiKey, data.task_id, params, responseDiv, badgeDiv, statusArea);
            }
        }
        
        async function fetchWithSSE(apiUrl, apiKey, params, responseDiv, badgeDiv, statusArea) {
            badgeDiv.innerHTML = '<span class="badge badge-loading">‚è≥ Connecting...</span>';
            responseDiv.innerHTML = '<div class="info-message">üì° Connecting to real-time stream...</div>';
            
            const eventSource = new EventSource(`${apiUrl}/api/data/fresh?${params}`, {
                headers: { 'X-API-Key': apiKey }
            });
            
            let messages = [];
            
            eventSource.onmessage = (event) => {
                const update = JSON.parse(event.data);
                
                if (update.type === 'cached') {
                    badgeDiv.innerHTML = '<span class="badge badge-cached">üì¶ Cached Data</span>';
                    updateStatus(statusArea, 'SSE - Cached', update.data, 'streaming');
                    messages.push('=== CACHED DATA (Instant) ===\n' + JSON.stringify(update.data, null, 2));
                } else if (update.type === 'status') {
                    badgeDiv.innerHTML = '<span class="badge badge-loading">‚è≥ ' + update.message + '</span>';
                    messages.push('\n=== STATUS ===\n' + update.message);
                } else if (update.type === 'fresh') {
                    badgeDiv.innerHTML = '<span class="badge badge-fresh">‚ú® Fresh Data</span>';
                    updateStatus(statusArea, 'SSE - Fresh', update.data, 'streaming');
                    messages.push('\n=== FRESH DATA (Updated) ===\n' + JSON.stringify(update.data, null, 2));
                } else if (update.type === 'complete') {
                    badgeDiv.innerHTML = '<span class="badge badge-fresh">‚úÖ Complete</span>';
                    messages.push('\n=== COMPLETE ===\n' + update.message);
                    eventSource.close();
                } else if (update.type === 'error') {
                    messages.push('\n=== ERROR ===\n' + update.message);
                    eventSource.close();
                }
                
                responseDiv.innerHTML = messages.join('\n\n');
                responseDiv.scrollTop = responseDiv.scrollHeight;
            };
            
            eventSource.onerror = (error) => {
                eventSource.close();
                badgeDiv.innerHTML = '<span class="badge badge-cached">Error</span>';
                responseDiv.innerHTML += '\n\n=== CONNECTION ERROR ===\nStream closed.';
            };
        }
        
        function startPollingTask(apiUrl, apiKey, taskId, params, responseDiv, badgeDiv, statusArea) {
            currentTaskId = taskId;
            
            taskCheckInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${apiUrl}/api/task/${taskId}?${params}`, {
                        headers: { 'X-API-Key': apiKey }
                    });
                    
                    const taskData = await response.json();
                    
                    if (taskData.task_status === 'completed') {
                        clearInterval(taskCheckInterval);
                        
                        // Show fresh data
                        badgeDiv.innerHTML = '<span class="badge badge-fresh">‚ú® Fresh Data Available!</span>';
                        
                        const freshDiv = document.createElement('div');
                        freshDiv.className = 'success-message';
                        freshDiv.innerHTML = '<strong>üéâ Fresh data is ready!</strong><br>Background scraping completed.';
                        responseDiv.insertBefore(freshDiv, responseDiv.firstChild);
                        
                        if (taskData.fresh_data) {
                            updateStatus(statusArea, 'Fresh Data', taskData.fresh_data, 'background');
                        }
                    } else if (taskData.task_status === 'failed') {
                        clearInterval(taskCheckInterval);
                        badgeDiv.innerHTML = '<span class="badge badge-cached">‚ùå Refresh Failed</span>';
                    }
                } catch (error) {
                    console.error('Error checking task:', error);
                }
            }, 2000); // Check every 2 seconds
        }
        
        function showLoading(responseDiv, badgeDiv, message) {
            badgeDiv.innerHTML = '<span class="badge badge-loading">‚è≥ Loading...</span>';
            responseDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <div><strong>${message}</strong></div>
                </div>
            `;
        }
        
        function showRefreshMessage(responseDiv, data) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'info-message';
            messageDiv.innerHTML = `
                <strong>‚ÑπÔ∏è Background Refresh Triggered</strong><br>
                Task ID: ${data.task_id}<br>
                ${data.message}<br>
                <em>The display will update automatically when fresh data is ready.</em>
            `;
            responseDiv.insertBefore(messageDiv, responseDiv.firstChild);
        }
        
        function updateStatus(statusArea, type, data, time) {
            statusArea.style.display = 'block';
            document.getElementById('requestType').textContent = type;
            document.getElementById('totalRecords').textContent = data.total_count?.toLocaleString() || '-';
            document.getElementById('returnedRecords').textContent = data.returned_count?.toLocaleString() || '-';
            document.getElementById('rowRange').textContent = data.start_row && data.end_row ? 
                `${data.start_row} to ${data.end_row}` : 'All';
            document.getElementById('responseTime').textContent = time + 's';
        }
    </script>
</body>
</html>
